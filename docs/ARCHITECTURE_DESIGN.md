# Beat Boxer 게임 아키텍처 설계 문서

## A. 시스템 개요

### A.1 배경

Beat Boxer는 권투의 기술을 정확히 습득하고 타이밍 및 포즈를 유지하는 것에 중점을 둔 실시간 모션 인식 기반의 권투 리듬 게임입니다.
특히 어린이 사용자의 경우, 잘못된 자세가 습관이 되기 쉽기 때문에 정확한 포즈를 유지하는 것이 근육 발달과 부상 방지에 매우 중요합니다. 권투 포즈(가드 자세)는 코어 근육을 활용하고 균형 감각을 키우는 기초입니다.
본 게임은 사용자의 실제 신체 동작(정확한 펀치 궤적, 안정적인 회피 자세)을 카메라를 통해 실시간으로 감지하고 피드백을 제공합니다. 또한 플레이어의 행동 패턴을 분석하고 개인화된 교정을 제안하는 시스템입니다.


**기술적 배경:**
- MediaPipe: Google의 오픈소스 머신러닝 프레임워크로 실시간 포즈 추정 및 세그멘테이션 제공
- OpenCV: 실시간 카메라 영상 처리 및 컴퓨터 비전 작업
- Arcade: Python 기반 2D 게임 엔진으로 게임 렌더링 및 이벤트 처리
- Python 3.11+: 현대적인 타입 힌팅 및 성능 최적화 기능 활용
- scikit-learn: 클러스터링 알고리즘 (K-means, DBSCAN)을 통한 플레이어 행동 패턴 분석
- TensorFlow/PyTorch: 강화학습 모델을 통한 개인화된 교정 제안 시스템 (선택적)

### A.2 시스템 목적

**주요 목적:**
1. **실시간 모션 인식 게임플레이**: 사용자의 실제 신체 동작을 실시간으로 감지하여 게임에 반영
2. **정확한 타이밍 및 공간 판정**: 리듬 게임의 타이밍 판정과 공간적 위치 판정을 결합한 하이브리드 판정 시스템
3. **확장 가능한 아키텍처**: 모듈화된 설계로 새로운 노트 타입, 판정 로직, 게임 모드 추가 용이
4. **사용자 경험 최적화**: 실루엣 표시, 히트 이펙트, 시각적 피드백을 통한 몰입감 향상
5. **AI 기반 개인화 및 교정**: 클러스터링 모델을 통한 플레이어 행동 패턴 분석 및 강화학습 모델 기반 맞춤형 교정 제안

**비즈니스 목적:**
- 운동과 엔터테인먼트를 결합한 새로운 게임 장르 제시
- 컴퓨터 비전 기술의 실용적 응용 사례 제공
- 머신러닝 기반 개인화 시스템을 통한 사용자 경험 향상
- 오픈소스 프로젝트로 확장 가능한 플랫폼 구축

### A.3 시스템 범위

**포함 범위 (In-Scope):**
- 실시간 카메라 입력 처리 및 포즈 추정
- 4가지 노트 타입 처리 (JAB_L, JAB_R, WEAVE_L, WEAVE_R)
- 타이밍 및 공간 판정 시스템 (Perfect, Great, Good, Miss)
- 4가지 게임 씬 관리 (메인 메뉴, 캘리브레이션, 게임 플레이, 결과)
- 2가지 게임 모드 (일반 모드, 테스트 모드)
- 비트맵 기반 리듬 게임 시스템
- 점수 및 콤보 시스템
- 히트 이펙트 및 시각적 피드백
- 실루엣 외곽선 추출 및 렌더링
- **AI 기반 플레이어 행동 분석**: 클러스터링 모델을 통한 플레이어 행동 패턴 분류 및 분석
- **AI 기반 교정 제안**: 강화학습 모델을 통한 개인화된 동작 교정 및 개선 제안

**제외 범위 (Out-of-Scope):**
- 멀티플레이어 기능
- 온라인 리더보드
- 사용자 계정 시스템
- 비트맵 에디터
- 모바일 플랫폼 지원
- VR/AR 지원

### A.4 시스템 컨텍스트 다이어그램

```
┌─────────────────────────────────────────────────────────────┐
│                    Beat Boxer Game System                    │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│                    ┌─────────────────┐                       │
│                    │  main() 함수     │                       │
│                    │  (진입점)        │                       │
│                    └─────────────────┘                       │
│                            │                                 │
│                            ▼                                 │
│              ┌──────────────────────────┐                    │
│              │    GameFactory           │                    │
│              │  (컴포넌트 생성 관리)      │                    │
│              └──────────────────────────┘                    │
│         │              │              │                     │
│         │              │              │                     │
│         ▼              ▼              ▼                     │
│  ┌──────────┐   ┌──────────┐   ┌──────────┐              │
│  │Config    │   │Audio     │   │Pose      │              │
│  │Manager   │   │Manager   │   │Tracker   │              │
│  └──────────┘   └──────────┘   └──────────┘              │
│         ▲              │              │                     │
│         │              │              │                     │
│         │              ▼              │                     │
│  ┌──────────┐   ┌──────────┐   ┌──────────┐              │
│  │설정 파일  │   │리소스     │   │MediaPipe │              │
│  │(JSON)    │   │- sounds/ │   │(라이브러리)│              │
│  │- rules   │   │          │   │          │              │
│  │- diff    │   │          │   │          │              │
│  │- ui.json │   │          │   │          │              │
│  └──────────┘   └──────────┘   └──────────┘              │
│                                                               │
│                            │                                 │
│                            ▼                                 │
│              ┌──────────────────────────┐                    │
│              │    GameWindow             │                    │
│              │  (Arcade Window)          │                    │
│              │  - 카메라 프레임 읽기      │                    │
│              │  - OpenCV 처리            │                    │
│              │  - PoseTracker 호출       │                    │
│              │  - Scene에 데이터 전달     │                    │
│              └──────────────────────────┘                    │
│         ▲              │              ▲              ▲        │
│         │              │              │              │        │
│         │              ▼              │              │        │
│  ┌──────────┐   ┌──────────┐   ┌──────────┐  ┌──────────┐ │
│  │ Config   │   │ Audio    │   │ Pose     │  │ Capture  │ │
│  │ (객체)    │   │ Manager  │   │ Tracker  │  │ (카메라)  │ │
│  └──────────┘   └──────────┘   └──────────┘  └──────────┘ │
│         │              │              │              │        │
│         │              │              │              │        │
│         │              │              │              │        │
│  ┌──────────┐   ┌──────────┐   ┌──────────┐  ┌──────────┐ │
│  │설정 파일  │   │리소스     │   │MediaPipe │  │카메라     │ │
│  │(JSON)    │   │- sounds/ │   │(라이브러리)│  │(하드웨어) │ │
│  └──────────┘   └──────────┘   └──────────┘  └──────────┘ │
│                                                               │
│                            │                                 │
│                            ▼                                 │
│         ┌──────────────────┼──────────────────┐              │
│         │                  │                  │              │
│         ▼                  ▼                  ▼              │
│  ┌──────────┐      ┌──────────┐      ┌──────────┐         │
│  │  Menu   │      │Calibration│      │  Game    │         │
│  │  Scene  │      │  Scene   │      │  Scene   │         │
│  └──────────┘      └──────────┘      └──────────┘         │
│                            │                  │              │
│                            │                  │              │
│                            │                  ▼              │
│                            │          ┌──────────┐         │
│                            │          │  Result  │         │
│                            │          │  Scene   │         │
│                            │          └──────────┘         │
│                            │                  │              │
│                            │                  │              │
│                            └──────────────────┘              │
│                                       │                       │
│                                       │ (GameScene 내부)      │
│                                       ▼                       │
│              ┌──────────────────────────────────┐            │
│              │  GameScene 내부 컴포넌트          │            │
│              │  ┌────────────┐  ┌────────────┐ │            │
│              │  │Beatmap     │  │Note        │ │            │
│              │  │Loader      │  │Manager     │ │            │
│              │  └────────────┘  └────────────┘ │            │
│              │  ┌────────────┐  ┌────────────┐ │            │
│              │  │Score       │  │Judgment    │ │            │
│              │  │Manager     │  │Processor   │ │            │
│              │  └────────────┘  └────────────┘ │            │
│              │  ┌────────────┐  ┌────────────┐ │            │
│              │  │HitEffect   │  │Behavior    │ │            │
│              │  │System      │  │Analyzer    │ │            │
│              │  └────────────┘  └────────────┘ │            │
│              │  ┌────────────┐                  │            │
│              │  │Correction  │                  │            │
│              │  │Advisor     │                  │            │
│              │  └────────────┘                  │            │
│              └──────────────────────────────────┘            │
│              │              │              │                │
│              │              │              │                │
│              ▼              ▼              ▼                │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐    │
│  │리소스         │  │리소스         │  │ AI 모델       │    │
│  │- beatmaps/   │  │- images/     │  │- clustering  │    │
│  │(비트맵 파일)  │  │(배경 이미지)  │  │- rl_model    │    │
│  └──────────────┘  └──────────────┘  └──────────────┘    │
│                                        ▲                    │
│                                        │                    │
│                            ┌───────────┴───────────┐       │
│                            │   플레이 데이터 저장   │       │
│                            │   (데이터베이스/파일)  │       │
│                            └───────────────────────┘       │
│                                                               │
│  ┌──────────────────────────────────────────────────────┐   │
│  │  AI 기반 분석 및 교정 시스템                          │   │
│  │  ┌────────────────────┐  ┌────────────────────┐    │   │
│  │  │BehaviorAnalyzer    │  │CorrectionAdvisor   │    │   │
│  │  │(행동 분석)          │  │(교정 제안)          │    │   │
│  │  │- 데이터 수집        │  │- RL 모델 추론      │    │   │
│  │  │- 클러스터링         │  │- 교정 제안 생성    │    │   │
│  │  │- 패턴 분석          │  │- 난이도 조정       │    │   │
│  │  └────────────────────┘  └────────────────────┘    │   │
│  │         │                      │                     │   │
│  │         │                      │                     │   │
│  │         ▼                      ▼                     │   │
│  │  ┌──────────────┐      ┌──────────────┐           │   │
│  │  │플레이어 데이터 │      │AI 모델        │           │   │
│  │  │(판정, 타이밍) │      │(클러스터링, RL)│           │   │
│  │  │- 데이터베이스 │      │- 학습된 모델   │           │   │
│  │  │- 로컬 파일    │      │- 모델 파라미터 │           │   │
│  │  └──────────────┘      └──────────────┘           │   │
│  └──────────────────────────────────────────────────────┘   │
│                                                               │
│  ┌──────────────────────────────────────────────────────┐   │
│  │  런타임 데이터 흐름 (게임 루프)                        │   │
│  │  1. 카메라 → OpenCV → GameWindow.on_update()        │   │
│  │  2. GameWindow → PoseTracker.process_frame()        │   │
│  │  3. PoseTracker → hit_events, landmarks, mask       │   │
│  │  4. GameWindow.update_data → Scene.update()         │   │
│  │  5. GameScene → JudgmentProcessor → ScoreManager    │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                            │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  Logger (유틸리티)                                     │  │
│  │  - 모든 모듈에서 import하여 사용                          │   │
│  │  - 의존성 주입 없이 직접 사용                              │   │
│  └──────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘

**의존성 관계 설명:**

1. **초기화 흐름 (main → GameFactory → 컴포넌트)**:
   - `main()` 함수에서 `GameFactory`를 통해 컴포넌트 생성
   - `GameFactory.create_config_manager()` → `ConfigManager` 생성 → 설정 파일 읽기
   - `GameFactory.create_audio_manager()` → `AudioManager` 생성 → `load_sounds()` 호출 → 리소스(sounds/) 읽기
   - `GameFactory.create_camera()` → OpenCV 카메라 초기화 → capture 객체 반환
   - `GameFactory.create_pose_tracker()` → `PoseTracker` 생성 (config 사용, MediaPipe 내부 사용)

2. **GameWindow 의존성 및 역할**:
   - `GameWindow`는 `main()` 함수에서 생성 시 다음 의존성들을 받음 (의존성 주입):
     - `config`: ConfigManager.get_config()로 생성된 설정 객체 (설정 파일에서 읽음)
     - `audio_manager`: GameFactory.create_audio_manager()로 생성된 AudioManager 인스턴스
     - `pose_tracker`: GameFactory.create_pose_tracker()로 생성된 PoseTracker 인스턴스
     - `capture`: GameFactory.create_camera()로 생성된 cv2.VideoCapture 객체 (카메라 하드웨어 접근)
   - **런타임 동작**:
     - 카메라 프레임 읽기: `capture.read()` → OpenCV로 처리 (flip) → `PoseTracker.process_frame()` 호출
     - `update_data` 딕셔너리에 `frame`, `hit_events`, `landmarks`, `mask` 저장
     - 모든 Scene에 `audio_manager`, `config`, `pose_tracker` 전달 (의존성 주입)
     - `Scene.update()`에 `update_data` 전달 (매 프레임)

3. **Scene 의존성**:
   - 모든 Scene은 `audio_manager`, `config`, `pose_tracker`를 받음 (의존성 주입)
   - `GameScene`은 내부에서 여러 컴포넌트를 생성:
     - `BeatmapLoader`: `__init__`에서 생성 (config_difficulty 사용)
     - `NoteManager`, `ScoreManager`, `JudgmentProcessor`: `startup()`에서 초기화
     - `HitEffectSystem`: `__init__`에서 생성

4. **GameScene의 데이터 흐름**:
   - **비트맵 로딩**: `startup()` → `_load_beatmap()` → `BeatmapLoader.load_beatmap()` → 리소스(beatmaps/) 읽기 → `beatmap_items` 저장
   - **배경 이미지**: `startup()` → `_load_background()` → 리소스(images/) 읽기
   - **게임 실행**: `update()` → `JudgmentProcessor` → `ScoreManager` → 점수 업데이트

5. **런타임 데이터 흐름 (게임 루프)**:
   - 카메라 → OpenCV (GameWindow.on_update에서 capture.read()) → 프레임 flip
   - GameWindow → PoseTracker.process_frame() → hit_events, landmarks, mask 생성
   - GameWindow.update_data → Scene.update() (매 프레임 호출)
   - GameScene.update() → JudgmentProcessor.process_hit_events() → ScoreManager.register_hit() → GameState 업데이트

6. **AI 기반 분석 및 교정 데이터 흐름**:
   - **데이터 수집**: GameScene → BehaviorAnalyzer.collect_player_data() → 플레이어 행동 데이터 수집 (판정, 타이밍, 자세)
   - **행동 분석**: BehaviorAnalyzer.cluster_behavior_patterns() → 클러스터링 모델 실행 → 플레이어 그룹화 및 특징 분석
   - **교정 제안**: CorrectionAdvisor.generate_correction_suggestions() → 강화학습 모델 추론 → 개인화된 교정 제안 생성
   - **피드백 제공**: ResultScene 또는 GameScene → 교정 제안 표시 (실시간 또는 결과 화면)

7. **Logger**:
   - 모든 모듈에서 `from core.logger import get_logger`로 직접 import
   - 의존성 주입 없이 사용되는 유틸리티 모듈
```

**주요 외부 시스템:**
- **카메라 하드웨어**: macOS 기본 카메라 (AVFoundation)
- **MediaPipe 라이브러리**: 포즈 추정 및 세그멘테이션
- **Arcade 게임 엔진**: 렌더링 및 이벤트 처리
- **Pygame**: 오디오 재생
- **OpenCV**: 영상 처리
- **머신러닝 라이브러리** (선택적): 
  - scikit-learn: 클러스터링 모델 (K-means, DBSCAN)
  - TensorFlow/PyTorch: 강화학습 모델
- **데이터 저장소**: 로컬 파일 시스템 또는 데이터베이스 (플레이 데이터 저장)

### A.5 사용자 요구사항

**기능적 요구사항:**
1. **FR-1: 실시간 포즈 추적**
   - 사용자의 전신 랜드마크를 실시간으로 추적
   - 최소 30 FPS의 처리 속도 유지
   - 랜드마크 스무딩을 통한 안정적인 추적

2. **FR-2: 동작 인식**
   - 왼쪽/오른쪽 잽 (JAB_L, JAB_R) 인식
   - 왼쪽/오른쪽 위빙 (WEAVE_L, WEAVE_R) 인식
   - 동작 감지 시 히트 이벤트 생성

3. **FR-3: 노트 시스템**
   - 비트맵 파일에서 노트 정보 로드
   - 노트 스폰, 이동, 판정 처리
   - 4가지 노트 타입 지원

4. **FR-4: 판정 시스템**
   - 타이밍 판정 (Perfect, Great, Good, Miss)
   - 공간 판정 (히트존 내 손 위치 확인)
   - 위빙 판정 (코 위치 기반)

5. **FR-5: 게임 씬 관리**
   - 메인 메뉴 씬
   - 캘리브레이션 씬
   - 게임 플레이 씬
   - 결과 화면 씬

6. **FR-6: 게임 모드**
   - 일반 모드 (Normal Mode)
   - 테스트 모드 (Test Mode) - 디버그 정보 표시

7. **FR-7: AI 기반 행동 분석**
   - 플레이어의 게임플레이 패턴 데이터 수집 (판정 결과, 타이밍, 자세 등)
   - 클러스터링 모델을 통한 행동 패턴 그룹화
   - 플레이어 그룹별 특징 분석 및 시각화

8. **FR-8: AI 기반 교정 제안**
   - 강화학습 모델을 통한 개인화된 교정 제안 생성
   - 플레이어 행동 패턴 기반 난이도 조정 제안
   - 실시간 피드백 및 개선 방향 제시

**비기능적 요구사항:**
1. **NFR-1: 성능**
   - 실시간 처리: 최소 30 FPS 유지
   - 낮은 지연시간: 카메라 입력부터 화면 출력까지 100ms 이하

2. **NFR-2: 확장성**
   - 새로운 노트 타입 추가 용이
   - 새로운 게임 모드 추가 용이
   - 설정 파일 기반 밸런스 조정

3. **NFR-3: 유지보수성**
   - 모듈화된 코드 구조
   - 명확한 책임 분리
   - 타입 힌팅 및 문서화

4. **NFR-4: 사용성**
   - 직관적인 UI/UX
   - 명확한 시각적 피드백
   - 오류 처리 및 복구

## B. 시스템 요구사항

### B.1 기능요구사항

#### B.1.1 포즈 추적 및 동작 인식

| ID | 요구사항 | 설명 | 우선순위 |
|---|---|---|---|
| FR-1.1 | 실시간 포즈 추적 | MediaPipe를 사용하여 33개 랜드마크 실시간 추적 | 높음 |
| FR-1.2 | 랜드마크 스무딩 | 이동 평균 필터를 통한 랜드마크 위치 안정화 | 중간 |
| FR-1.3 | 세그멘테이션 마스크 | MediaPipe Selfie Segmentation을 통한 실루엣 추출 | 중간 |
| FR-1.4 | 잽 동작 감지 | 왼쪽/오른쪽 주먹의 속도, 각도, 위치 기반 감지 | 높음 |
| FR-1.5 | 위빙 동작 감지 | 코 랜드마크의 좌우 이동 기반 감지 | 높음 |
| FR-1.6 | 히트존 검증 | 주먹이 히트존 내부에 있는지 공간적 검증 | 높음 |

#### B.1.2 게임플레이 시스템

| ID | 요구사항 | 설명 | 우선순위 |
|---|---|---|---|
| FR-2.1 | 비트맵 로딩 | JSON 또는 텍스트 형식의 비트맵 파일 파싱 | 높음 |
| FR-2.2 | 노트 스폰 | 비트맵 타이밍에 맞춰 노트 생성 | 높음 |
| FR-2.3 | 노트 이동 | 노트가 히트존으로 이동하는 애니메이션 | 높음 |
| FR-2.4 | 타이밍 판정 | 노트 도달 시간과 동작 시간의 차이 계산 | 높음 |
| FR-2.5 | 공간 판정 | 주먹 위치와 히트존의 공간적 일치 검증 | 높음 |
| FR-2.6 | 점수 계산 | 판정 등급에 따른 점수 및 콤보 계산 | 중간 |
| FR-2.7 | 게임 종료 | 모든 노트 처리 완료 시 게임 종료 | 중간 |

#### B.1.3 사용자 인터페이스

| ID | 요구사항 | 설명 | 우선순위 |
|---|---|---|---|
| FR-3.1 | 메인 메뉴 | 게임 시작 옵션 제공 | 중간 |
| FR-3.2 | 캘리브레이션 화면 | 사용자 위치 및 자세 캘리브레이션 | 높음 |
| FR-3.3 | 게임 HUD | 점수, 콤보, 판정 결과 표시 | 높음 |
| FR-3.4 | 결과 화면 | 최종 점수, 콤보, 판정 통계 표시 | 중간 |
| FR-3.5 | 실루엣 표시 | 실시간 인물 실루엣 외곽선 표시 | 중간 |
| FR-3.6 | 히트 이펙트 | 판정 시 파티클 효과 표시 | 낮음 |

#### B.1.4 게임 모드

| ID | 요구사항 | 설명 | 우선순위 |
|---|---|---|---|
| FR-4.1 | 일반 모드 | 기본 게임플레이 모드 | 높음 |
| FR-4.2 | 테스트 모드 | 디버그 정보 및 상세 판정 로그 표시 | 중간 |
| FR-4.3 | 모드 전환 | 게임 중 모드 전환 기능 | 낮음 |

#### B.1.5 AI 기반 행동 분석 및 교정 제안

| ID | 요구사항 | 설명 | 우선순위 |
|---|---|---|---|
| FR-5.1 | 플레이어 데이터 수집 | 게임플레이 중 판정 결과, 타이밍, 자세 데이터 수집 | 중간 |
| FR-5.2 | 행동 패턴 클러스터링 | 클러스터링 모델(K-means, DBSCAN 등)을 통한 플레이어 그룹화 | 중간 |
| FR-5.3 | 패턴 분석 | 각 클러스터별 특징 분석 (평균 판정률, 취약 노트 타입 등) | 중간 |
| FR-5.4 | 강화학습 모델 | 플레이어 행동 패턴 기반 개인화된 교정 제안 생성 | 중간 |
| FR-5.5 | 교정 제안 제공 | 실시간 또는 결과 화면에서 개선 방향 제시 | 낮음 |
| FR-5.6 | 난이도 자동 조정 | 학습된 모델을 통한 난이도 동적 조정 제안 | 낮음 |

### B.2 품질요구사항

#### B.2.1 성능 요구사항

| ID | 요구사항 | 목표 값 | 측정 방법 |
|---|---|---|---|
| QR-1.1 | 프레임 레이트 | 최소 30 FPS | Arcade 내장 FPS 카운터 |
| QR-1.2 | 포즈 추정 지연 | 100ms 이하 | 타임스탬프 측정 |
| QR-1.3 | 메모리 사용량 | 500MB 이하 | 시스템 모니터링 |
| QR-1.4 | CPU 사용률 | 70% 이하 (단일 코어) | 시스템 모니터링 |

#### B.2.2 신뢰성 요구사항

| ID | 요구사항 | 설명 |
|---|---|---|
| QR-2.1 | 오류 처리 | 카메라 연결 실패, 파일 로드 실패 등 예외 상황 처리 |
| QR-2.2 | 안정성 | 장시간 실행 시 메모리 누수 없음 |
| QR-2.3 | 복구 능력 | 일시적 오류 후 자동 복구 또는 명확한 오류 메시지 |

#### B.2.3 사용성 요구사항

| ID | 요구사항 | 설명 |
|---|---|---|
| QR-3.1 | 직관적 조작 | 키보드 단축키로 모든 기능 접근 가능 |
| QR-3.2 | 시각적 피드백 | 판정 결과, 히트존 상태를 명확하게 표시 |
| QR-3.3 | 반응성 | 사용자 입력에 즉각적인 시각적 반응 |

#### B.2.4 유지보수성 요구사항

| ID | 요구사항 | 설명 |
|---|---|---|
| QR-4.1 | 모듈화 | 각 기능이 독립적인 모듈로 분리 |
| QR-4.2 | 확장성 | 새로운 노트 타입, 모드 추가 용이 |
| QR-4.3 | 문서화 | 코드 주석 및 타입 힌팅 제공 |

### B.3 제약사항

#### B.3.1 기술적 제약사항

| 제약사항 | 설명 | 영향 |
|---|---|---|
| C-1 | Python 3.11+ 필요 | 하위 버전 호환성 없음 |
| C-2 | macOS 기본 카메라만 지원 | 다른 OS의 카메라 API 미지원 |
| C-3 | MediaPipe 모델 복잡도 | 높은 정확도 요구 시 CPU 사용량 증가 |
| C-4 | 실시간 처리 요구 | 배치 처리 불가, 실시간 스트림만 지원 |

#### B.3.2 하드웨어 제약사항

| 제약사항 | 설명 | 영향 |
|---|---|---|
| C-5 | 카메라 필수 | 카메라 없이는 게임 실행 불가 |
| C-6 | 충분한 조명 필요 | 어두운 환경에서 포즈 추정 정확도 저하 |
| C-7 | 충분한 공간 필요 | 사용자가 카메라 앞에서 동작할 공간 필요 |

#### B.3.3 소프트웨어 제약사항

| 제약사항 | 설명 | 영향 |
|---|---|---|
| C-8 | 외부 라이브러리 의존성 | MediaPipe, OpenCV, Arcade 등 필수 |
| C-9 | 설정 파일 형식 | JSON 형식만 지원 |
| C-10 | 비트맵 형식 | 텍스트 또는 JSON 형식만 지원 |

## C. 아키텍처 설계 문제 분석

### C.1 선정된 아키텍처 드라이버

아키텍처 드라이버는 시스템의 핵심 설계 결정에 영향을 미치는 요구사항입니다.

#### C.1.1 주요 아키텍처 드라이버

1. **실시간 성능 (Performance)**
   - **중요도**: 매우 높음
   - **영향**: 전체 시스템 아키텍처
   - **설명**: 30 FPS 이상의 실시간 처리가 필수적이며, 이는 모든 컴포넌트의 설계에 영향을 미침

2. **확장성 (Extensibility)**
   - **중요도**: 높음
   - **영향**: 모듈 구조 및 인터페이스 설계
   - **설명**: 새로운 노트 타입, 게임 모드, 판정 로직 추가가 용이해야 함

3. **모듈화 (Modularity)**
   - **중요도**: 높음
   - **영향**: 컴포넌트 분리 및 의존성 관리
   - **설명**: 각 기능이 독립적으로 개발 및 테스트 가능해야 함

4. **유지보수성 (Maintainability)**
   - **중요도**: 중간
   - **영향**: 코드 구조 및 문서화
   - **설명**: 장기적인 프로젝트 유지보수를 위한 명확한 구조 필요

5. **테스트 가능성 (Testability)**
   - **중요도**: 중간
   - **영향**: 의존성 주입 및 인터페이스 설계
   - **설명**: 단위 테스트 및 통합 테스트 가능한 구조

### C.2 아키텍처 설계 문제 분석표

| 문제 ID | 설계 문제 | 관련 드라이버 | 우선순위 | 해결 방안 |
|---|---|---|---|---|
| P-1 | 실시간 포즈 추정과 게임 렌더링의 동기화 | 성능 | 높음 | 별도 스레드에서 포즈 추정, 메인 스레드에서 렌더링 |
| P-2 | 다양한 노트 타입의 확장 가능한 처리 | 확장성 | 높음 | Strategy 패턴 및 팩토리 패턴 활용 |
| P-3 | 게임 상태의 중앙 관리 | 모듈화 | 중간 | GameState 클래스로 상태 중앙화 |
| P-4 | 판정 로직의 복잡성 관리 | 유지보수성 | 높음 | JudgmentProcessor로 판정 로직 분리 |
| P-5 | 씬 간 데이터 전달 | 모듈화 | 중간 | persistent_data 딕셔너리 활용 |
| P-6 | 설정 파일의 중앙 관리 | 유지보수성 | 중간 | ConfigManager로 설정 통합 관리 |
| P-7 | 컴포넌트 간 의존성 관리 | 테스트 가능성 | 높음 | GameFactory를 통한 의존성 주입 |
| P-8 | 게임 모드별 다른 동작 처리 | 확장성 | 높음 | Strategy 패턴으로 모드 분리 |
| P-9 | 노트 생명주기 관리 | 모듈화 | 중간 | NoteManager로 노트 관리 분리 |
| P-10 | 좌표계 변환 (카메라 ↔ 화면) | 유지보수성 | 중간 | BaseScene의 to_arcade_xy 메서드 통합 |
| P-11 | 플레이어 행동 패턴 분석 | 확장성 | 중간 | BehaviorAnalyzer로 클러스터링 로직 분리 |
| P-12 | 개인화된 교정 제안 | 확장성 | 중간 | CorrectionAdvisor로 RL 모델 관리 및 교정 제안 생성 |
| P-13 | AI 모델 성능 최적화 | 성능 | 낮음 | 배치 처리 및 모델 경량화를 통한 실시간 처리 가능 |

## D. 설계절차

### D.1 아키텍처 스타일

본 시스템은 **계층화 아키텍처 (Layered Architecture)**와 **전략 패턴 (Strategy Pattern)**을 결합한 하이브리드 아키텍처를 채택합니다.

#### D.1.1 계층화 아키텍처

본 시스템은 5계층 레이어드 아키텍처를 채택하여 시스템의 명확한 책임 분리와 의존성 관리를 구현합니다.

```
┌─────────────────────────────────────────────────────────────────────┐
│ Layer 1: Intelligence & Analytics Layer (지능 및 분석 계층)         │
├─────────────────────────────────────────────────────────────────────┤
│  역할: 게임 플레이 데이터 분석 및 AI 기반 맞춤형 교정 피드백 생성    │
│  ┌──────────────────────────────────┐  ┌─────────────────────────┐ │
│  │ 플레이어 행동 분석                │  │ 교정 제안 강화학습      │ │
│  │ (클러스터링 모델)                 │  │ (RL 모델)               │ │
│  │ - BehaviorAnalyzer               │  │ - CorrectionAdvisor     │ │
│  │ - 행동 패턴 클러스터링             │  │ - 개인화된 교정 제안    │ │
│  │ - 플레이어 유형 식별              │  │ - 난이도 조정 제안      │ │
│  └──────────────────────────────────┘  └─────────────────────────┘ │
│                            ▲                                         │
│                            │ (게임 플레이 데이터 분석)                │
└─────────────────────────────────────────────────────────────────────┘
                            │
                            │
┌─────────────────────────────────────────────────────────────────────┐
│ Layer 2: Presentation & Interaction Layer (표현 및 상호작용 계층)    │
├─────────────────────────────────────────────────────────────────────┤
│  역할: 사용자에게 게임 화면 표시 및 플레이어 동작 판정 수행          │
│  ┌──────────────────────────────────┐  ┌─────────────────────────┐ │
│  │ Game SCENE (Arcade)              │  │ Judgement Processor     │ │
│  │ - Scene Manager                  │  │ - 판정 등급 결정        │ │
│  │ - MainMenuScene                  │  │ - 타이밍/공간 판정      │ │
│  │ - CalibrationScene               │  │ - 노트 매칭            │ │
│  │ - GameScene                      │  │ - HitEffectManager 연동 │ │
│  │ - TestScene                      │  └─────────────────────────┘ │
│  │ - ResultScene                    │                            │
│  │ - UI 렌더링                      │                            │
│  └──────────────────────────────────┘                            │
│                            ▲                                         │
│                            │ (게임 상태 및 로직)                      │
└─────────────────────────────────────────────────────────────────────┘
                            │
                            │
┌─────────────────────────────────────────────────────────────────────┐
│ Layer 3: Core Logic & Management Layer (핵심 로직 및 관리 계층)      │
├─────────────────────────────────────────────────────────────────────┤
│  역할: 게임의 핵심 비즈니스 로직 및 상태 관리                        │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐           │
│  │ Score        │  │ Note         │  │ Image        │           │
│  │ Manager      │  │ Manager      │  │ Processing   │           │
│  │ - 점수 계산   │  │ - 노트 스폰   │  │ - 실루엣 처리 │           │
│  │ - 콤보 관리   │  │ - 노트 업데이트│  │ - 렌더링 처리│           │
│  │ - 판정 기록   │  │ - 노트 정리   │  │              │           │
│  └──────────────┘  └──────────────┘  └──────────────┘           │
│  ┌──────────────┐                                                  │
│  │ Hit Effect   │                                                  │
│  │ Manager      │                                                  │
│  │ - 파티클 효과 │                                                  │
│  │ - 시각적 피드백│                                                 │
│  └──────────────┘                                                  │
│                            ▲                                         │
│                            │ (로드된 데이터 및 입력)                  │
└─────────────────────────────────────────────────────────────────────┘
                            │
                            │
┌─────────────────────────────────────────────────────────────────────┐
│ Layer 4: Data Access & Loading Layer (데이터 접근 및 로딩 계층)      │
├─────────────────────────────────────────────────────────────────────┤
│  역할: 원본 데이터 로딩 및 외부 입력 처리                            │
│  ┌──────────────────────────────────┐  ┌─────────────────────────┐ │
│  │ Asset, Configure Loader          │  │ Input Loader            │ │
│  │ - 비트맵 로딩 (BeatmapLoader)     │  │ - 카메라 입력 처리      │ │
│  │ - 오디오 로딩 (AudioManager)      │  │ - 키보드 입력 처리      │ │
│  │ - 이미지 로딩                     │  │ - 포즈 데이터 처리      │ │
│  │ - 설정 파일 로딩 (ConfigManager)  │  │ - PoseTracker 연동      │ │
│  └──────────────────────────────────┘  └─────────────────────────┘ │
│                            ▲                                         │
│                            │ (원본 데이터 및 외부 입력)               │
└─────────────────────────────────────────────────────────────────────┘
                            │
                            │
┌─────────────────────────────────────────────────────────────────────┐
│ Layer 5: Resource & Input Layer (리소스 및 입력 계층)               │
├─────────────────────────────────────────────────────────────────────┤
│  역할: 게임에 필요한 모든 원본 데이터 및 외부 입력 정의              │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐         │
│  │ Game     │  │ Audio    │  │ Beatmaps │  │ Background│        │
│  │ Rule     │  │ Files    │  │ Note     │  │ Image    │         │
│  │ (JSON)   │  │ (sounds/)│  │ (txt/json)│  │ (jpg/png)│         │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘         │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐                      │
│  │ Camera   │  │ Keyboard │  │ Configure│                      │
│  │ (Hardware)│  │ (Input)  │  │ (JSON)   │                      │
│  └──────────┘  └──────────┘  └──────────┘                      │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

**계층별 책임 및 데이터 흐름:**

- **Layer 1: Intelligence & Analytics Layer (지능 및 분석 계층)**
  - 게임 플레이 데이터를 분석하여 플레이어의 습관과 패턴을 파악
  - 클러스터링 모델을 통한 행동 패턴 분류 및 플레이어 유형 식별
  - 강화학습 모델을 통한 개인화된 교정 제안 생성
  - 난이도 동적 조정 제안
  - **데이터 흐름**: Layer 2의 판정 결과를 입력으로 받아 분석하고, 교정 제안을 Layer 4로 피드백

- **Layer 2: Presentation & Interaction Layer (표현 및 상호작용 계층)**
  - 사용자에게 실제 게임 화면을 렌더링하고 표시
  - 플레이어의 핵심 동작(잽, 위빙)에 대한 판정 수행
  - 씬 관리 및 전환 처리
  - **데이터 흐름**: Layer 3의 게임 상태를 받아 렌더링하고, Layer 1에 판정 결과 전달

- **Layer 3: Core Logic & Management Layer (핵심 로직 및 관리 계층)**
  - 게임의 핵심 비즈니스 로직 관리 (점수, 노트, 이펙트)
  - 게임 상태의 실질적인 관리 및 업데이트
  - 이미지 처리 및 시각 효과 관리
  - **데이터 흐름**: Layer 4에서 로드된 데이터를 받아 게임 로직 실행, Layer 2에 상태 전달

- **Layer 4: Data Access & Loading Layer (데이터 접근 및 로딩 계층)**
  - Layer 5의 원본 데이터를 시스템이 사용할 수 있는 형태로 로딩
  - 외부 입력(카메라, 키보드)을 처리하고 정규화
  - 포즈 트래커와의 연동을 통한 동작 데이터 추출
  - **데이터 흐름**: Layer 5의 원본 데이터를 로드하고, Layer 1의 교정 제안을 반영하여 Layer 3에 전달

- **Layer 5: Resource & Input Layer (리소스 및 입력 계층)**
  - 게임에 필요한 모든 원본 데이터 정의 (설정 파일, 오디오, 비트맵, 이미지)
  - 외부 입력 소스 정의 (카메라 하드웨어, 키보드 입력)
  - 정적 리소스 및 동적 입력의 최상위 정의
  - **데이터 흐름**: Layer 4로 원본 데이터 제공, Layer 1의 피드백을 받아 설정 조정 가능

**피드백 루프:**
- Layer 1 → Layer 4: AI 분석 결과를 기반으로 게임 설정 및 로딩 방식 조정
- Layer 2 → Layer 1: 판정 결과를 AI 분석 모델에 입력하여 학습 데이터 제공
- Layer 3 → Layer 2: 게임 상태를 실시간으로 화면에 반영

#### D.1.2 전략 패턴 (Strategy Pattern)

게임 모드별 다른 동작을 처리하기 위해 Strategy 패턴을 사용합니다.

```
GameModeStrategy (Abstract)
    ├── NormalModeStrategy
    └── TestModeStrategy
```

**장점:**
- 새로운 게임 모드 추가 시 기존 코드 수정 없이 확장 가능
- 각 모드의 로직이 명확하게 분리됨
- 테스트 및 디버깅 용이

#### D.1.3 팩토리 패턴 (Factory Pattern)

컴포넌트 생성 및 의존성 주입을 위해 Factory 패턴을 사용합니다.

```
GameFactory
    ├── create_audio_manager()
    ├── create_camera()
    ├── create_pose_tracker()
    └── create_config_manager()
```

**장점:**
- 컴포넌트 생성 로직 중앙화
- 의존성 주입을 통한 느슨한 결합
- 테스트 시 Mock 객체 주입 용이

### D.2 아키텍처 관점 체계

#### D.2.1 기능적 관점 (Functional View)

**주요 기능 모듈:**

1. **포즈 추적 모듈** (`core/pose_tracker.py`)
   - MediaPipe 포즈 추정
   - 동작 감지 (잽, 위빙)
   - 히트존 검증

2. **게임 로직 모듈** (`core/judgment_processor.py`, `core/note_manager.py`)
   - 노트 관리 및 판정 처리
   - 점수 계산 및 콤보 관리

3. **씬 관리 모듈** (`scenes/`)
   - 씬 전환 및 상태 관리
   - UI 렌더링

4. **리소스 관리 모듈** (`core/audio_manager.py`, `core/beatmap_loader.py`)
   - 오디오 재생
   - 비트맵 로딩

#### D.2.2 개발 관점 (Development View)

**모듈 구조:**

```
beat_boxer_game/
├── main.py                 # 진입점
├── core/                   # 핵심 로직 모듈
│   ├── game_factory.py    # 팩토리 패턴
│   ├── game_state.py      # 상태 관리
│   ├── judgment_processor.py  # 판정 처리
│   ├── note_manager.py     # 노트 관리
│   ├── pose_tracker.py     # 포즈 추적
│   └── ...
├── scenes/                 # 씬 모듈
│   ├── base_scene.py      # 기본 씬 클래스
│   ├── game_scene.py      # 게임 씬
│   └── ...
└── config/                 # 설정 파일
    ├── rules.json
    ├── difficulty.json
    └── ui.json
```

**의존성 규칙:**
- `scenes/`는 `core/`에 의존
- `core/`는 외부 라이브러리에만 의존
- `main.py`는 모든 모듈을 조율

#### D.2.3 배포 관점 (Deployment View)

**실행 환경:**
- **OS**: macOS (현재)
- **Python**: 3.11+
- **의존성**: requirements.txt에 명시

**배포 단위:**
- 단일 실행 파일 (PyInstaller로 패키징 가능)
- 설정 파일 및 리소스 파일 포함

### D.3 아키텍처 설계절차의 정의

#### D.3.1 설계 단계

1. **요구사항 분석** (완료)
   - 기능 요구사항 정의
   - 비기능 요구사항 정의
   - 제약사항 파악

2. **아키텍처 드라이버 선정** (완료)
   - 실시간 성능, 확장성, 모듈화 등 핵심 드라이버 식별

3. **아키텍처 스타일 선택** (완료)
   - 계층화 아키텍처 + Strategy 패턴 + Factory 패턴

4. **컴포넌트 설계** (완료)
   - 각 계층별 컴포넌트 정의
   - 인터페이스 및 의존성 설계

5. **구현 및 검증** (진행 중)
   - 코드 구현
   - 단위 테스트
   - 통합 테스트

#### D.3.2 설계 원칙

1. **단일 책임 원칙 (SRP)**
   - 각 클래스는 하나의 책임만 가짐
   - 예: `NoteManager`는 노트 관리만, `JudgmentProcessor`는 판정만

2. **개방-폐쇄 원칙 (OCP)**
   - 확장에는 열려있고 수정에는 닫혀있음
   - Strategy 패턴으로 새로운 모드 추가 시 기존 코드 수정 없음

3. **의존성 역전 원칙 (DIP)**
   - 고수준 모듈은 저수준 모듈에 의존하지 않음
   - 인터페이스를 통한 추상화

4. **의존성 주입 (DI)**
   - GameFactory를 통한 컴포넌트 생성 및 주입
   - 테스트 시 Mock 객체 주입 가능

## E. 아키텍처 설계 결과

### E.1 전체 시스템 아키텍처

```
┌──────────────────────────────────────────────────────────────┐
│                         GameWindow                            │
│                    (Arcade Window Manager)                   │
│  - 씬 전환 관리                                                │
│  - 카메라 프레임 처리                                          │
│  - 포즈 추정 결과 전달                                         │
└──────────────────────────────────────────────────────────────┘
                            │
        ┌───────────────────┼───────────────────┐
        │                   │                   │
        ▼                   ▼                   ▼
┌──────────────┐    ┌──────────────┐    ┌──────────────┐
│ MainMenuScene│    │CalibrationScene│   │  GameScene   │
└──────────────┘    └──────────────┘    └──────────────┘
        │                   │                   │
        │                   │                   │
        └───────────────────┼───────────────────┘
                            │
                            ▼
                    ┌──────────────┐
                    │ ResultScene  │
                    └──────────────┘
```

### E.2 GameScene 상세 아키텍처

```
┌──────────────────────────────────────────────────────────────┐
│                        GameScene                              │
├──────────────────────────────────────────────────────────────┤
│                                                               │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              GameModeStrategy                        │   │
│  │  ┌──────────────┐          ┌──────────────┐         │   │
│  │  │NormalMode   │          │ TestMode     │         │   │
│  │  │Strategy     │          │ Strategy     │         │   │
│  │  └──────────────┘          └──────────────┘         │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                               │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │ NoteManager  │  │Judgment      │  │ ScoreManager │      │
│  │              │  │Processor     │  │              │      │
│  │ - 스폰       │  │ - 판정 처리   │  │ - 점수 계산   │      │
│  │ - 업데이트   │  │ - 이벤트 매칭 │  │ - 콤보 관리   │      │
│  │ - 정리       │  │              │  │              │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
│                                                               │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │ BeatmapLoader│  │ GameState     │  │ HitEffect     │      │
│  │              │  │              │  │ System        │      │
│  │ - 비트맵 로드 │  │ - 상태 관리   │  │ - 파티클 효과 │      │
│  │ - 파싱       │  │ - 판정 기록   │  │              │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
│                                                               │
│  ┌──────────────┐  ┌──────────────┐                         │
│  │Behavior      │  │Correction    │                         │
│  │Analyzer      │  │Advisor       │                         │
│  │              │  │              │                         │
│  │ - 데이터 수집 │  │ - RL 모델     │                         │
│  │ - 클러스터링  │  │ - 교정 제안   │                         │
│  │ - 패턴 분석   │  │ - 난이도 조정 │                         │
│  └──────────────┘  └──────────────┘                         │
│                                                               │
└──────────────────────────────────────────────────────────────┘
```

### E.3 컴포넌트 상세 설계

#### E.3.1 PoseTracker

**책임:**
- MediaPipe를 사용한 포즈 추정
- 동작 감지 (잽, 위빙)
- 히트존 검증
- 세그멘테이션 마스크 생성

**주요 메서드:**
- `process_frame(frame, now)`: 프레임 처리 및 히트 이벤트 생성
- `check_calibration_position(...)`: 캘리브레이션 위치 확인
- `_detect_jab_l/r(...)`: 잽 동작 감지
- `_detect_weave_l/r(...)`: 위빙 동작 감지

#### E.3.2 JudgmentProcessor

**책임:**
- 히트 이벤트와 노트 매칭
- 타이밍 및 공간 판정
- 판정 등급 결정 (Perfect, Great, Good, Miss)
- ScoreManager와 HitEffectSystem 호출

**주요 메서드:**
- `process_hit_events(...)`: 히트 이벤트 처리
- `process_weave_judgments(...)`: 위빙 판정 처리
- `_find_best_matching_note(...)`: 최적 노트 매칭
- `_determine_judgement(...)`: 판정 등급 결정

#### E.3.3 NoteManager

**책임:**
- 노트 스폰
- 노트 업데이트 (위치, 상태)
- 노트 정리 (히트/미스 처리된 노트 제거)

**주요 메서드:**
- `spawn_note(...)`: 새 노트 생성
- `update_notes(...)`: 모든 노트 업데이트
- `get_active_notes()`: 활성 노트 리스트 반환
- `cleanup_notes(...)`: 처리된 노트 제거

#### E.3.4 GameState

**책임:**
- 게임 상태 중앙 관리
- 점수, 콤보, 판정 기록
- 게임 타이밍 정보

**주요 속성:**
- `score`, `combo`, `max_combo`
- `song_start_time`, `game_finished`
- `last_judgement_type`, `judge_log`

#### E.3.5 GameFactory

**책임:**
- 컴포넌트 생성 및 초기화
- 의존성 주입
- 설정 로드

**주요 메서드:**
- `create_audio_manager()`: 오디오 매니저 생성
- `create_camera()`: 카메라 초기화
- `create_pose_tracker(...)`: 포즈 트래커 생성
- `create_config_manager()`: 설정 매니저 생성

#### E.3.6 BehaviorAnalyzer (AI 기반 행동 분석)

**책임:**
- 플레이어 게임플레이 데이터 수집 (판정 결과, 타이밍, 자세 등)
- 클러스터링 모델(K-means, DBSCAN 등)을 통한 행동 패턴 그룹화
- 각 클러스터별 특징 분석 (평균 판정률, 취약 노트 타입, 타이밍 패턴 등)
- 플레이어 그룹 시각화 및 통계 생성

**주요 메서드:**
- `collect_player_data(...)`: 게임플레이 중 플레이어 행동 데이터 수집
- `cluster_behavior_patterns(...)`: 클러스터링 모델을 통한 패턴 그룹화
- `analyze_cluster_features(...)`: 클러스터별 특징 분석
- `get_player_cluster(...)`: 특정 플레이어의 클러스터 할당
- `get_behavior_insights(...)`: 행동 패턴 인사이트 생성

**의존성:**
- scikit-learn: 클러스터링 알고리즘 (K-means, DBSCAN)
- numpy: 수치 연산 및 데이터 처리
- pandas (선택적): 데이터 분석 및 시각화

#### E.3.7 CorrectionAdvisor (강화학습 기반 교정 제안)

**책임:**
- 플레이어 행동 패턴 기반 개인화된 교정 제안 생성
- 강화학습 모델을 통한 최적 교정 전략 학습
- 실시간 또는 결과 화면에서 개선 방향 제시
- 난이도 동적 조정 제안

**주요 메서드:**
- `generate_correction_suggestions(...)`: 플레이어 패턴 기반 교정 제안 생성
- `update_rl_model(...)`: 강화학습 모델 업데이트 (학습)
- `get_personalized_feedback(...)`: 개인화된 피드백 제공
- `suggest_difficulty_adjustment(...)`: 난이도 조정 제안
- `record_improvement(...)`: 개선 효과 기록 및 모델 보상 업데이트

**의존성:**
- TensorFlow/PyTorch: 강화학습 모델 구현
- OpenAI Gym (선택적): RL 환경 구현
- numpy: 수치 연산

**상태 공간 (State Space):**
- 플레이어의 판정 분포 (Perfect, Great, Good, Miss 비율)
- 노트 타입별 성공률
- 타이밍 패턴 (평균 타이밍 오차)
- 클러스터 정보

**행동 공간 (Action Space):**
- 교정 제안 유형 (자세 개선, 타이밍 연습, 특정 노트 타입 연습 등)
- 난이도 조정 제안 (Easy, Normal, Hard)
- 피드백 강도 조정

**보상 함수 (Reward Function):**
- 플레이어의 판정 개선 정도
- 장기적 게임플레이 지속성
- 플레이어 만족도 지표

### E.4 데이터 흐름

#### E.4.1 게임 루프 데이터 흐름

```
카메라 프레임
    │
    ▼
PoseTracker.process_frame()
    │
    ├─▶ 히트 이벤트 생성
    ├─▶ 랜드마크 추출
    └─▶ 세그멘테이션 마스크
    │
    ▼
GameWindow.on_update()
    │
    ├─▶ update_data 딕셔너리 업데이트
    │
    ▼
GameScene.update()
    │
    ├─▶ NoteManager.update_notes()
    ├─▶ JudgmentProcessor.process_hit_events()
    └─▶ ScoreManager 업데이트
    │
    ▼
GameScene.draw_scene()
    │
    ├─▶ 배경 렌더링
    ├─▶ 실루엣 렌더링
    ├─▶ 노트 렌더링
    ├─▶ HUD 렌더링
    └─▶ 히트 이펙트 렌더링
```

#### E.4.2 판정 처리 데이터 흐름

```
PoseTracker
    │ (히트 이벤트 생성)
    ▼
JudgmentProcessor.process_hit_events()
    │
    ├─▶ _find_best_matching_note() - 노트 매칭
    │
    ├─▶ _determine_judgement() - 판정 등급 결정
    │
    ├─▶ ScoreManager.register_hit() - 점수 업데이트
    │
    ├─▶ HitEffectSystem.add_effect() - 이펙트 추가
    │
    └─▶ BehaviorAnalyzer.collect_play_data() - 플레이 데이터 수집
```

#### E.4.3 AI 기반 분석 및 교정 데이터 흐름

```
게임 플레이 데이터
    │ (판정 결과, 타이밍, 자세)
    ▼
BehaviorAnalyzer
    │
    ├─▶ 데이터 저장 및 누적
    │
    ├─▶ 클러스터링 모델 실행
    │   │
    │   └─▶ 행동 패턴 분류
    │       │
    │       └─▶ 플레이어 유형 식별
    │
    └─▶ 행동 패턴 통계 생성
        │
        ▼
CorrectionAdvisor
    │
    ├─▶ 약점 영역 분석
    │
    ├─▶ 강화학습 모델 실행
    │   │
    │   ├─▶ 상태 (State): 현재 플레이어 성능, 행동 패턴
    │   ├─▶ 행동 (Action): 교정 제안 유형 선택
    │   └─▶ 보상 (Reward): 플레이어 개선 정도
    │
    └─▶ 개인화된 교정 제안 생성
        │
        ▼
사용자 인터페이스
    │
    └─▶ 교정 제안 표시 (결과 화면 또는 별도 UI)
```
    ├─▶ BehaviorAnalyzer.collect_player_data()
    │    - 판정 결과, 타이밍, 자세 데이터 수집
    │    - 데이터베이스 또는 로컬 파일에 저장
    │
    ▼ (주기적 또는 게임 종료 시)
BehaviorAnalyzer.cluster_behavior_patterns()
    │
    ├─▶ 클러스터링 모델 실행 (K-means, DBSCAN 등)
    │
    ├─▶ 플레이어 클러스터 할당
    │
    └─▶ 클러스터 특징 분석
    │
    ▼
CorrectionAdvisor.generate_correction_suggestions()
    │
    ├─▶ 강화학습 모델 추론
    │
    ├─▶ 플레이어 행동 패턴 분석
    │
    ├─▶ 개인화된 교정 제안 생성
    │
    └─▶ 난이도 조정 제안
    │
    ▼
ResultScene 또는 GameScene
    │
    └─▶ 교정 제안 표시
        - 실시간 피드백
        - 결과 화면 분석 리포트
        - 개선 방향 제시
```

### E.5 인터페이스 설계

#### E.5.1 BaseScene 인터페이스

```python
class BaseScene(arcade.View):
    def startup(self, persistent_data: Dict) -> None
    def cleanup(self) -> Dict[str, Any]
    def set_source_dimensions(self, width: int, height: int) -> None
    def to_arcade_xy(self, camera_point: Tuple[int, int]) -> Tuple[float, float]
```

#### E.5.2 GameModeStrategy 인터페이스

```python
class GameModeStrategy(ABC):
    @abstractmethod
    def handle_hits(self, hit_events, t_game: float, now: float, **kwargs) -> None
    
    @abstractmethod
    def _draw_mode_specific_hud(self) -> None
    
    def get_hit_zone_color(self, default_color: Tuple[int, int, int]) -> Tuple[int, int, int]
    def draw_additional(self, now: float) -> None
```

## F. 설계결과의 분석

### F.1 아키텍처 설계 결정표

| 결정 ID | 설계 결정 | 대안 | 선택 이유 |
|---|---|---|---|
| AD-1 | 계층화 아키텍처 채택 | 마이크로서비스, 이벤트 기반 | 단일 프로세스 게임에 적합, 명확한 책임 분리 |
| AD-2 | Strategy 패턴으로 게임 모드 분리 | if-else 분기, 상속 | 확장성 및 유지보수성 향상 |
| AD-3 | Factory 패턴으로 컴포넌트 생성 | 직접 인스턴스화 | 의존성 주입 및 테스트 용이성 |
| AD-4 | GameState로 상태 중앙화 | 분산 상태 관리 | 상태 일관성 보장 및 디버깅 용이 |
| AD-5 | 모듈별 독립적 책임 분리 | 단일 클래스에 모든 로직 | 단일 책임 원칙 준수, 테스트 용이 |
| AD-6 | JSON 설정 파일 사용 | 하드코딩, XML | 가독성 및 수정 용이성 |
| AD-7 | Arcade 게임 엔진 사용 | Pygame 직접 사용, Unity | Python 네이티브, 간단한 2D 게임에 적합 |
| AD-8 | MediaPipe 포즈 추정 | OpenPose, 자체 구현 | 실시간 성능 및 정확도, Google 지원 |
| AD-9 | 실시간 단일 스레드 처리 | 멀티스레드 | Arcade의 단일 스레드 모델 준수, 동기화 복잡도 감소 |
| AD-10 | Scene 기반 화면 관리 | 단일 화면, 상태 머신 | 명확한 화면 전환 및 상태 관리 |

### F.2 아키텍처 분석 관점 및 분석 결과

#### F.2.1 성능 분석

**강점:**
- ✅ 실시간 포즈 추정: MediaPipe의 최적화된 모델 사용
- ✅ 효율적인 노트 관리: NoteManager의 활성 노트만 처리
- ✅ 단일 스레드 모델: 동기화 오버헤드 없음

**약점 및 개선 방안:**
- ⚠️ 포즈 추정이 메인 스레드에서 실행되어 렌더링 지연 가능
  - **개선 방안**: 별도 스레드에서 포즈 추정 후 결과를 큐에 전달
- ⚠️ 대량의 노트 처리 시 성능 저하 가능
  - **개선 방안**: 공간 인덱싱 (Spatial Hashing) 도입

#### F.2.2 확장성 분석

**강점:**
- ✅ Strategy 패턴으로 새로운 게임 모드 추가 용이
- ✅ Note 클래스 확장으로 새로운 노트 타입 추가 가능
- ✅ 설정 파일 기반 밸런스 조정

**약점 및 개선 방안:**
- ⚠️ 새로운 판정 로직 추가 시 JudgmentProcessor 수정 필요
  - **개선 방안**: Chain of Responsibility 패턴 도입
- ⚠️ 비트맵 형식이 제한적 (텍스트/JSON만)
  - **개선 방안**: 플러그인 시스템으로 다양한 형식 지원

#### F.2.3 유지보수성 분석

**강점:**
- ✅ 명확한 모듈 분리
- ✅ 타입 힌팅 및 문서화
- ✅ 설정 파일 분리로 코드 수정 없이 밸런스 조정 가능

**약점 및 개선 방안:**
- ⚠️ 일부 클래스가 여전히 큰 책임을 가짐 (GameScene)
  - **개선 방안**: 추가 리팩토링으로 책임 분리
- ⚠️ 테스트 코드 부족
  - **개선 방안**: 단위 테스트 및 통합 테스트 추가

#### F.2.4 테스트 가능성 분석

**강점:**
- ✅ Factory 패턴으로 Mock 객체 주입 가능
- ✅ GameState로 상태 격리 가능
- ✅ 모듈별 독립적 테스트 가능

**약점 및 개선 방안:**
- ⚠️ 실제 테스트 코드 부재
  - **개선 방안**: pytest 기반 테스트 프레임워크 도입
- ⚠️ 카메라 의존성으로 통합 테스트 어려움
  - **개선 방안**: Mock 카메라 객체 제공

#### F.2.5 보안 분석

**현재 상태:**
- ✅ 외부 네트워크 통신 없음
- ✅ 로컬 파일 시스템만 접근
- ✅ 사용자 데이터 수집 없음

**향후 고려사항:**
- 온라인 기능 추가 시 보안 고려 필요

---

## 결론

본 아키텍처 설계 문서는 Beat Boxer 게임의 현재 구조를 분석하고 체계적으로 문서화한 것입니다. 계층화 아키텍처와 Strategy 패턴, Factory 패턴을 결합하여 확장 가능하고 유지보수하기 쉬운 시스템을 구축했습니다.

**주요 성과:**
- 모듈화된 구조로 각 컴포넌트의 책임이 명확히 분리됨
- Strategy 패턴으로 게임 모드 확장 용이
- Factory 패턴으로 의존성 주입 및 테스트 용이성 확보
- 설정 파일 기반 밸런스 조정으로 코드 수정 없이 게임 조정 가능

**향후 개선 방향:**
- 멀티스레딩을 통한 성능 최적화
- 테스트 코드 추가로 품질 보장
- 추가 리팩토링으로 더 세밀한 책임 분리
- 플러그인 시스템으로 확장성 향상

**AI/ML 기능 확장:**
- 클러스터링 모델 고도화 (K-means, DBSCAN 등 다양한 알고리즘 지원)
- 강화학습 모델 최적화 (PPO, A3C 등 다양한 RL 알고리즘 실험)
- 실시간 교정 제안을 위한 온라인 학습 지원
- 다중 플레이어 데이터 기반 집단 학습 및 패턴 발견
- 시각화 대시보드 개발 (행동 패턴, 학습 곡선, 교정 효과 등)

