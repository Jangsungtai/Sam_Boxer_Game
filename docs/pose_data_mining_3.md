# 3단계: 포즈품질 습관 평가

## 개요

3단계에서는 게임이 끝난 후 수집된 모든 노트 데이터에 대해 1단계의 기준 포즈(Centroid)와 2단계의 평가항목 가중치(w_i)를 사용하여 노트별 품질 점수를 계산하고, 그 결과를 모아 사용자의 포즈 품질과 습관을 분석한 종합 보고서를 생성합니다.

**사용 기법**: 가중 유클리드 거리 (Weighted Euclidean Distance) + 통계 분석  
**역할**: 사용자 포즈 습관 및 개선점 분석 → 종합 교정 보고서 생성

---

## 목표

게임이 끝난 후, 수집된 모든 노트 데이터에 대해 1단계의 기준 포즈(Centroid)와 2단계의 평가항목 가중치(w_i)를 사용하여 노트별 품질 점수를 계산하고, 그 결과를 모아 사용자의 포즈 품질과 습관을 분석한 종합 보고서를 생성합니다.

---

## 방법론

### 가중 유클리드 거리 (Weighted Euclidean Distance)

가중 유클리드 거리는 사용자 포즈와 기준 포즈 간의 차이를 계산하는 방법입니다. 2단계에서 추출한 변수 중요도를 가중치로 사용하여, 중요한 변수의 오차에 더 높은 가중치를 부여합니다.

**공식**:
```
Distance = √(Σ w_i × (x_user,i - x_기준,i)²)
```

여기서:
- `w_i`: 2단계에서 추출한 변수 i의 중요도 (가중치)
- `x_user,i`: 사용자 포즈의 변수 i 값
- `x_기준,i`: 기준 포즈의 변수 i 값 (1단계 Centroid)

**점수 변환**:
```
score = 100 × exp(-2 × (distance / max_distance))
```

거리가 작을수록 점수가 높아지며, 0~100 범위의 점수로 변환됩니다.

### 통계 분석

각 포즈 타입별로 다음 통계를 계산합니다:

1. **평균 품질 점수**: 모든 노트의 평균 점수
2. **점수 분산/표준편차**: 포즈 일관성 측정
3. **최고/최저 점수**: 최고 및 최저 성능 기록
4. **변수별 평균 오차**: 각 변수에서 기준과의 평균 차이
5. **변수별 오차 표준편차**: 각 변수의 일관성 측정
6. **최대 오차 노트 분석**: 가장 큰 오차를 보인 상위 5개 노트 분석

---

## 입력 데이터

- **사용자 포즈 데이터**: `data/pose_data/초심자 Sample2.csv` (104개 포즈)
- **1단계 기준 포즈 벡터**: `data/pose_standards.json`
- **2단계 변수 가중치**: `data/pose_evaluation_weights.json`

---

## 처리 결과

### 전체 요약

| 포즈 타입 | 수행 횟수 | 평균 점수 | 점수 범위 | 일관성 (표준편차) |
|----------|----------|----------|----------|------------------|
| GUARD | 26 | 55.5 | 26.4 ~ 89.2 | 19.2 (높음) |
| JAB_L | 26 | 15.3 | 0.0 ~ 31.8 | 8.5 (낮음) |
| STRAIGHT_R | 26 | 42.5 | 20.4 ~ 74.2 | 16.3 (높음) |
| WEAVE_L | 13 | 39.7 | 0.0 ~ 91.7 | 39.5 (높음) |
| WEAVE_R | 13 | 61.5 | 18.7 ~ 79.9 | 14.2 (보통) |

**주요 발견:**
- WEAVE_R이 가장 높은 평균 점수를 기록 (61.5점)
- GUARD가 두 번째로 높은 점수를 기록 (55.5점)
- JAB_L이 가장 낮은 점수를 기록 (15.3점)
- WEAVE_L의 일관성이 가장 낮음 (표준편차 39.5)

---

## 포즈 타입별 상세 분석

### 1. GUARD (가드) 포즈

**평균 점수**: 55.5점  
**점수 범위**: 26.4 ~ 89.2점  
**일관성**: 표준편차 19.2 (높음)  
**수행 횟수**: 26회

**주요 문제 변수**:
- `right_arm_angle`: 평균 오차 59.419 → 오른팔 각도가 기준보다 크게 벗어남
- `left_fist_angle`: 평균 오차 -13.229 → 왼손 각도가 기준보다 작음
- `right_fist_angle`: 평균 오차 13.212 → 오른손 각도가 기준보다 큼

**교정 방향**:
- 전반적인 포즈 개선이 필요합니다.
- 포즈 일관성을 높이기 위한 연습이 필요합니다.
- 오른팔 각도를 기준에 맞게 조정하는 것이 가장 중요합니다.
- 왼손과 오른손의 각도를 기준에 맞게 조정해야 합니다.

### 2. JAB_L (왼손 잽) 포즈

**평균 점수**: 15.3점  
**점수 범위**: 0.0 ~ 31.8점  
**일관성**: 표준편차 8.5 (낮음)  
**수행 횟수**: 26회

**주요 문제 변수**:
- `left_fist_angle`: 평균 오차 -79.191 → 왼손 각도가 기준보다 크게 작음
- `right_arm_angle`: 평균 오차 -132.004 → 오른팔 각도가 기준보다 크게 작음
- `right_fist_angle`: 평균 오차 110.292 → 오른손 각도가 기준보다 크게 큼

**교정 방향**:
- 전반적인 포즈 개선이 필요합니다.
- 왼손 각도와 오른팔 각도를 기준에 맞게 조정하는 것이 가장 중요합니다.
- 오른손 각도도 기준에 맞게 조정해야 합니다.

### 3. STRAIGHT_R (오른손 스트레이트) 포즈

**평균 점수**: 42.5점  
**점수 범위**: 20.4 ~ 74.2점  
**일관성**: 표준편차 16.3 (높음)  
**수행 횟수**: 26회

**주요 문제 변수**:
- `right_fist_angle`: 평균 오차 69.937 → 오른손 각도가 기준보다 크게 벗어남
- `left_fist_angle`: 평균 오차 -11.500 → 왼손 각도가 기준보다 작음
- `left_arm_angle`: 평균 오차 10.092 → 왼팔 각도가 기준보다 큼

**교정 방향**:
- 전반적인 포즈 개선이 필요합니다.
- 포즈 일관성을 높이기 위한 연습이 필요합니다.
- 오른손 각도를 기준에 맞게 조정하는 것이 가장 중요합니다.
- 왼손과 왼팔의 각도도 기준에 맞게 조정해야 합니다.

### 4. WEAVE_L (위빙 좌) 포즈

**평균 점수**: 39.7점  
**점수 범위**: 0.0 ~ 91.7점  
**일관성**: 표준편차 39.5 (높음)  
**수행 횟수**: 13회

**주요 문제 변수**:
- `left_fist_angle`: 평균 오차 95.880 → 왼손 각도가 기준보다 크게 벗어남
- `left_arm_angle`: 평균 오차 -68.309 → 왼팔 각도가 기준보다 작음
- `right_fist_angle`: 평균 오차 -65.469 → 오른손 각도가 기준보다 작음

**교정 방향**:
- 전반적인 포즈 개선이 필요합니다.
- 포즈 일관성을 높이기 위한 연습이 필요합니다.
- 왼손 각도를 기준에 맞게 조정하는 것이 가장 중요합니다.

### 5. WEAVE_R (위빙 우) 포즈

**평균 점수**: 61.5점  
**점수 범위**: 18.7 ~ 79.9점  
**일관성**: 표준편차 14.2 (보통)  
**수행 횟수**: 13회

**주요 문제 변수**:
- `left_fist_angle`: 평균 오차 4.995 → 왼손 각도가 기준보다 약간 큼
- `left_arm_angle`: 평균 오차 -8.160 → 왼팔 각도가 기준보다 작음
- `right_fist_angle`: 평균 오차 34.479 → 오른손 각도가 기준보다 큼

**교정 방향**:
- 전반적인 포즈 개선이 필요합니다.
- 오른손 각도를 기준에 맞게 조정하는 것이 중요합니다.

---

## 결과 파일

### JSON 파일

**파일 경로**: `reports/3.report/pose_quality_report.json`

이 파일에는 각 포즈 타입별 상세 분석 결과가 저장되어 있습니다:
- 노트별 품질 점수 및 거리
- 변수별 평균 오차 및 표준편차
- 최대 오차 노트 분석
- 최악의 변수 분석

### 텍스트 보고서

**파일 경로**: `reports/3.report/pose_quality_report.txt`

이 파일에는 포즈 타입별 진단 결과와 교정 방향이 요약되어 있습니다.

### 시각화 파일

모든 시각화 파일은 `reports/3.report/` 폴더에 저장되어 있습니다:

1. **reports/3.report/3.1_mean_score_comparison.png**: 포즈 타입별 평균 점수 비교 차트
2. **reports/3.report/3.2_score_distribution.png**: 포즈 타입별 점수 분포 (박스플롯)
3. **reports/3.report/3.3_variable_error_heatmap.png**: 포즈 타입별 변수 평균 오차 히트맵
4. **reports/3.report/3.4_consistency_comparison.png**: 포즈 타입별 일관성 비교 차트

---

## 주요 발견 사항

### 1. WEAVE_R이 가장 양호

WEAVE_R 포즈가 평균 61.5점으로 가장 높은 점수를 기록했습니다. 일관성도 보통 수준(표준편차 14.2)으로 상대적으로 안정적입니다.

### 2. GUARD가 두 번째로 양호

GUARD 포즈가 평균 55.5점으로 두 번째로 높은 점수를 기록했습니다. 하지만 일관성이 높아 (표준편차 19.2) 개선이 필요합니다.

### 3. JAB_L이 가장 낮은 점수

JAB_L 포즈가 평균 15.3점으로 가장 낮은 점수를 기록했습니다. 전반적인 개선이 필요합니다.

### 3. 팔 각도와 손 각도가 주요 문제

대부분의 포즈 타입에서 팔 각도(`left_arm_angle`, `right_arm_angle`)와 손 각도(`left_fist_angle`, `right_fist_angle`)가 기준과 크게 벗어나 있습니다.

### 4. 일관성 부족

WEAVE_L을 제외한 대부분의 포즈 타입에서 일관성이 낮거나 매우 낮게 나타났습니다. 이는 같은 포즈를 반복할 때마다 자세가 일관되지 않음을 의미합니다.

---

## 개선 권장 사항

### 1. 기본 자세 연습

- 모든 포즈 타입에서 기본 자세를 정확히 익히는 것이 중요합니다.
- 특히 GUARD 포즈를 정확히 유지하는 연습이 필요합니다.

### 2. 팔 각도 조정

- 대부분의 포즈에서 팔 각도가 기준과 크게 벗어나 있습니다.
- 팔을 적절한 각도로 유지하는 연습이 필요합니다.

### 3. 손 각도 조정

- 손 각도도 기준과 크게 벗어나 있습니다.
- 손의 위치와 각도를 정확히 유지하는 연습이 필요합니다.

### 4. 일관성 향상

- 같은 포즈를 반복할 때마다 일관된 자세를 유지하는 연습이 필요합니다.
- 특히 WEAVE_L 포즈의 일관성을 높이는 것이 중요합니다.

---

## 가중 유클리드 거리 계산 예시

```python
import json
import numpy as np

# 기준 벡터와 가중치 로드
with open('data/pose_standards.json', 'r', encoding='utf-8') as f:
    standards = json.load(f)

with open('data/pose_evaluation_weights.json', 'r', encoding='utf-8') as f:
    weights = json.load(f)

# GUARD 포즈의 기준 벡터와 가중치
guard_centroid = standards['results']['GUARD']['centroid']
guard_weights = weights['results']['GUARD']['feature_importance']

# 사용자 포즈
user_pose = {
    'left_fist_dist': 0.688,
    'left_fist_angle': 311.18,
    'right_fist_dist': 0.624,
    'right_fist_angle': 168.08,
    'left_arm_angle': 9.53,
    'right_arm_angle': 29.59,
    'nose_position': -0.010,
    'nose_above_shoulder': 1.0
}

# 가중 유클리드 거리 계산
distance_squared = 0.0
for var in VARIABLES:
    user_value = user_pose[var]
    centroid_value = guard_centroid[var]
    weight = guard_weights[var]
    
    diff = user_value - centroid_value
    distance_squared += weight * (diff ** 2)

distance = np.sqrt(distance_squared)

# 점수 변환
max_distance = 100.0
if distance <= 0:
    score = 100.0
elif distance >= max_distance:
    score = 0.0
else:
    normalized = distance / max_distance
    score = 100 * np.exp(-2 * normalized)

print(f"거리: {distance:.2f}")
print(f"점수: {score:.1f}점")
```

---

## 주의사항

1. **점수 해석**: 점수가 낮다고 해서 반드시 나쁜 것은 아닙니다. 점수는 기준 포즈와의 거리를 나타내며, 개선의 여지가 있음을 의미합니다.

2. **데이터 품질**: 평가 결과는 수집된 데이터의 품질에 의존합니다. 더 많은 데이터가 수집되면 더 정확한 평가가 가능합니다.

3. **개인차**: 사람마다 체형과 자세가 다르므로, 기준 포즈와 완전히 일치하지 않아도 정상일 수 있습니다.

4. **지속적 개선**: 포즈 품질은 지속적인 연습과 개선을 통해 향상될 수 있습니다.

---

## 다음 단계

3단계에서 생성된 종합 보고서를 바탕으로:

1. **개인 맞춤형 교정 계획 수립**: 주요 문제 변수를 중심으로 교정 계획을 수립합니다.
2. **지속적인 모니터링**: 정기적으로 포즈 품질을 평가하여 개선 여부를 확인합니다.
3. **데이터 축적**: 더 많은 데이터를 수집하여 더 정확한 평가가 가능하도록 합니다.

---

## 참고 자료

- 가중 유클리드 거리: [Wikipedia - Euclidean Distance](https://en.wikipedia.org/wiki/Euclidean_distance)
- 통계 분석: [scipy.stats 문서](https://docs.scipy.org/doc/scipy/reference/stats.html)
- 데이터 시각화: [matplotlib 문서](https://matplotlib.org/stable/contents.html)

